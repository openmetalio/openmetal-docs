"use strict";(self.webpackChunkopenmetal_docs=self.webpackChunkopenmetal_docs||[]).push([[673],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return d}});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=o.createContext({}),c=function(e){var t=o.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=c(e.components);return o.createElement(i.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,i=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),h=c(n),d=a,m=h["".concat(i,".").concat(d)]||h[d]||u[d]||r;return n?o.createElement(m,l(l({ref:t},p),{},{components:n})):o.createElement(m,l({ref:t},p))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,l=new Array(r);l[0]=h;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:a,l[1]=s;for(var c=2;c<r;c++)l[c]=n[c];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},9941:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return i},metadata:function(){return c},toc:function(){return p},default:function(){return h}});var o=n(7462),a=n(3366),r=(n(7294),n(3905)),l=["components"],s={},i="Troubleshooting a Private Cloud's Ceph Cluster",c={unversionedId:"operators-manual/day-4/troubleshooting/ceph",id:"operators-manual/day-4/troubleshooting/ceph",title:"Troubleshooting a Private Cloud's Ceph Cluster",description:"Introduction",source:"@site/docs/operators-manual/day-4/troubleshooting/ceph.md",sourceDirName:"operators-manual/day-4/troubleshooting",slug:"/operators-manual/day-4/troubleshooting/ceph",permalink:"/openmetal-docs/docs/operators-manual/day-4/troubleshooting/ceph",editUrl:"https://github.com/inmotionhosting/openmetal-docs/blob/main/docs/operators-manual/day-4/troubleshooting/ceph.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Security and Your OpenMetal Private Cloud",permalink:"/openmetal-docs/docs/operators-manual/day-4/security/security-best-practices"},next:{title:"Guidelines for Searching through OpenStack Logs",permalink:"/openmetal-docs/docs/operators-manual/day-4/troubleshooting/log-filtering"}},p=[{value:"Introduction",id:"introduction",children:[],level:2},{value:"Table of Contents",id:"table-of-contents",children:[],level:2},{value:"Prerequisites",id:"prerequisites",children:[{value:"Root Access to OpenStack Control Plane",id:"root-access-to-openstack-control-plane",children:[],level:3}],level:2},{value:"Get Ceph&#39;s Status",id:"get-cephs-status",children:[],level:2},{value:"Ceph Log Files",id:"ceph-log-files",children:[],level:2},{value:"Common Issues",id:"common-issues",children:[{value:"Clock Skew",id:"clock-skew",children:[{value:"Confirm Ceph&#39;s Health",id:"confirm-cephs-health",children:[],level:4},{value:"Examine Chrony Logs",id:"examine-chrony-logs",children:[],level:4},{value:"Addressing Clock Skew",id:"addressing-clock-skew",children:[],level:4}],level:3}],level:2},{value:"References",id:"references",children:[],level:2}],u={toc:p};function h(e){var t=e.components,n=(0,a.Z)(e,l);return(0,r.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"troubleshooting-a-private-clouds-ceph-cluster"},"Troubleshooting a Private Cloud's Ceph Cluster"),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"In this guide, we explain how to get started troubleshooting issues with\nyour Private Cloud's Ceph cluster. A goal of this guide is to collect\ncommon troubleshooting scenarios and outline a method of addressing\nthem."),(0,r.kt)("h2",{id:"table-of-contents"},"Table of Contents"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"ceph#prerequisites"},"Prerequisites")),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"ceph#root-access-to-openstack-control-plane"},"Root Access to OpenStack Control\nPlane")))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"ceph#get-ceph-s-status"},"Get Ceph's\nStatus"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"ceph#ceph-log-files"},"Ceph Log\nFiles"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"ceph#common-issues"},"Common\nIssues")),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"ceph#clock-skew"},"Clock\nSkew")),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"ceph#confirm-ceph-s-health"},"Confirm Ceph's\nHealth")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"ceph#examine-chrony-logs"},"Examine Chrony\nLogs")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"ceph#addressing-clock-skew"},"Addressing Clock\nSkew")))))))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"ceph#reference"},"References")))),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("h3",{id:"root-access-to-openstack-control-plane"},"Root Access to OpenStack Control Plane"),(0,r.kt)("p",null,"Root access to your cloud's control plane nodes is required."),(0,r.kt)("h2",{id:"get-cephs-status"},"Get Ceph's Status"),(0,r.kt)("p",null,"In most troubleshooting cases, you can get an overview of your Ceph\ncluster by checking its status. To check your Ceph cluster's status, use\n",(0,r.kt)("inlineCode",{parentName:"p"},"ceph status"),"."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# ceph status\n  cluster:\n    id:     34fa49b3-fff8-4702-8b17-4e8d873c845f\n    health: HEALTH_WARN\n            clock skew detected on mon.focused-capybara, mon.lovely-ladybug\n            2 daemons have recently crashed\n\n  services:\n    mon: 3 daemons, quorum relaxed-flamingo,focused-capybara,lovely-ladybug (age 5d)\n    mgr: relaxed-flamingo(active, since 5d), standbys: focused-capybara, lovely-ladybug\n    osd: 4 osds: 4 up (since 5d), 4 in (since 13d)\n    rgw: 3 daemons active (focused-capybara.rgw0, lovely-ladybug.rgw0, relaxed-flamingo.rgw0)\n\n  task status:\n\n  data:\n    pools:   13 pools, 337 pgs\n    objects: 110.16k objects, 388 GiB\n    usage:   1.1 TiB used, 11 TiB / 12 TiB avail\n    pgs:     337 active+clean\n\n  io:\n    client:   381 KiB/s rd, 1.2 MiB/s wr, 444 op/s rd, 214 op/s wr\n")),(0,r.kt)("h2",{id:"ceph-log-files"},"Ceph Log Files"),(0,r.kt)("p",null,"Ceph's log files are stored in ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/log/ceph/")," within each control\nplane node."),(0,r.kt)("p",null,"For example, listed are all log files for host ",(0,r.kt)("inlineCode",{parentName:"p"},"focused-capybara"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# ls -1 /var/log/ceph/*.log\n/var/log/ceph/ceph.audit.log\n/var/log/ceph/ceph.log\n/var/log/ceph/ceph-mgr.focused-capybara.log\n/var/log/ceph/ceph-mon.focused-capybara.log\n/var/log/ceph/ceph-osd.1.log\n/var/log/ceph/ceph-rgw-focused-capybara.rgw0.log\n/var/log/ceph/ceph-volume.log\n")),(0,r.kt)("p",null,"A OpenMetal Ceph cluster is comprised of several services: Ceph's\nManager, Monitor, OSD, and RADOSGW"),(0,r.kt)("p",null,"Ceph has a primary log file, log files for each service, and additional\nlog files."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Primary Log File"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"/var/log/ceph/ceph.log")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Ceph Monitor Log File"),":\n",(0,r.kt)("inlineCode",{parentName:"li"},"/var/log/ceph/ceph-mon.focused-capybara.log")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Ceph RADOSGW Log File"),":\n",(0,r.kt)("inlineCode",{parentName:"li"},"/var/log/ceph/ceph-rgw-focused-capybara.rgw0.log"))),(0,r.kt)("p",null,"If you are unsure which Ceph service's log to look through, consider\nstarting with the primary log file, ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/log/ceph/ceph.log"),"."),(0,r.kt)("h2",{id:"common-issues"},"Common Issues"),(0,r.kt)("h3",{id:"clock-skew"},"Clock Skew"),(0,r.kt)("p",null,"Ceph has a number of health checks, including one for clock skew, called\n",(0,r.kt)("inlineCode",{parentName:"p"},"MON_CLOCK_SKEW"),". For more, see Ceph's ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ceph.com/en/latest/rados/operations/health-checks/"},"Health\nChecks"),"\nguide and look for the text ",(0,r.kt)("strong",{parentName:"p"},"MON","_","CLOCK","_","SKEW"),". Ceph in our\nconfiguration uses ",(0,r.kt)("inlineCode",{parentName:"p"},"chronyd")," to sync each node's clock. Kolla Ansible is\nresponsible for installing and configuring ",(0,r.kt)("inlineCode",{parentName:"p"},"chronyd")," into a Docker\ncontainer for each Ceph Monitor node. To administer ",(0,r.kt)("inlineCode",{parentName:"p"},"chronyd")," you must\ndo so through Docker."),(0,r.kt)("h4",{id:"confirm-cephs-health"},"Confirm Ceph's Health"),(0,r.kt)("p",null,"To confirm the status of this health check, execute ",(0,r.kt)("inlineCode",{parentName:"p"},"ceph status")," and\nexamine the output."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"cluster:\n  id:     34fa49b3-fff8-4702-8b17-4e8d873c845f\n  health: HEALTH_WARN\n          clock skew detected on mon.focused-capybara, mon.lovely-ladybug\n[...output truncated...]\n")),(0,r.kt)("p",null,"Alternatively, execute ",(0,r.kt)("inlineCode",{parentName:"p"},"ceph health detail")," to only see the status of\nhealth checks."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"HEALTH_WARN clock skew detected on mon.focused-capybara, mon.lovely-ladybug\n[WRN] MON_CLOCK_SKEW: clock skew detected on mon.focused-capybara, mon.lovely-ladybug\n    mon.focused-capybara clock skew 0.663159s > max 0.05s (latency 0.000399254s)\n    mon.lovely-ladybug clock skew 0.368233s > max 0.05s (latency 0.000385143s)\n")),(0,r.kt)("h4",{id:"examine-chrony-logs"},"Examine Chrony Logs"),(0,r.kt)("p",null,"From here, you may want to examine the logs for each ",(0,r.kt)("inlineCode",{parentName:"p"},"chrony")," Docker\ninstance running."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"docker logs chrony\n")),(0,r.kt)("p",null,"Alternatively, consider viewing logs on the local file system for\n",(0,r.kt)("inlineCode",{parentName:"p"},"chrony")," via ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/log/kolla/chrony/"),"."),(0,r.kt)("h4",{id:"addressing-clock-skew"},"Addressing Clock Skew"),(0,r.kt)("p",null,"There may be a number of methods to addressing clock skew. In this\nexample, we outline addressing this issue by restarting ",(0,r.kt)("inlineCode",{parentName:"p"},"chrony")," for\neach node."),(0,r.kt)("p",null,"To address the ",(0,r.kt)("inlineCode",{parentName:"p"},"MON_CLOCK_SKEW")," for the example output in this section,\nthe Docker container ",(0,r.kt)("inlineCode",{parentName:"p"},"chrony")," was restarted for each node. For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# docker restart chrony\nchrony\n")),(0,r.kt)("p",null,"Next, perform the same Ceph health check as before to confirm the\nstatus. For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# ceph health detail\nHEALTH_OK\n")),(0,r.kt)("p",null,"If the clock skew issue is no longer present, you should see the status\nof ",(0,r.kt)("inlineCode",{parentName:"p"},"HEALTH_OK")," assuming there are no other issues with the Ceph cluster."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note","!")," -- Restarting ",(0,r.kt)("inlineCode",{parentName:"p"},"chrony")," may be a heavy handed approach to\naddressing the issue. Consider alternatively making using of ",(0,r.kt)("inlineCode",{parentName:"p"},"chronyc"),"'s\n",(0,r.kt)("inlineCode",{parentName:"p"},"tracking"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"sources"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"sourcestats")," subcommands to diagnose clock\nskew issues."),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Ceph's\n",(0,r.kt)("a",{parentName:"li",href:"https://docs.ceph.com/en/latest/rados/troubleshooting/index.html"},"Troubleshooting")),(0,r.kt)("li",{parentName:"ul"},"Ceph's ",(0,r.kt)("a",{parentName:"li",href:"https://docs.ceph.com/en/latest/rados/troubleshooting/troubleshooting-mon/"},"Troubleshooting\nMonitors"))))}h.isMDXComponent=!0}}]);